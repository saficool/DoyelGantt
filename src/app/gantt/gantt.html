<div class="toolbar">
  <strong>Gantt</strong>
  <button class="btn btn-sm btn-primary" (click)="zoomHours(12)">Hour</button>
  <button class="btn btn-sm btn-primary" (click)="zoomHours(48)">Day</button>
  <button class="btn btn-sm btn-primary" (click)="zoomIn()">+</button>
  <button class="btn btn-sm btn-primary" (click)="zoomOut()">-</button>
  <button class="btn btn-sm btn-primary" (click)="toggleGridHours()">Show</button>
  <div class="legend">px/hr: {{pxPerHour}} · Range: {{viewStart | date:'MMM d'}}–{{viewEnd | date:'MMM d, y'}}</div>
</div>


<div class="gantt-container">

  <div class="machine-column">
    @for (row of rowLayout; track $index) {
    <div class="machine-row">
      <span class="machine-name">{{ row.resource.name }}</span>
      <button class="btn btn-sm btn-light" (click)="openTaskForm(row.resource.id)" data-bs-toggle="modal"
        data-bs-target="#exampleModal">+</button>

      <div class="modal fade" id="exampleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">New Task ({{row.resource.name}})</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form [formGroup]="taskForm">
                <div class="row g-3">
                  <div class="col-sm-10">
                    <div class="input-group">
                      <span class="input-group-text" id="task-name">Task Name</span>
                      <input type="text" class="form-control shadow-none" formControlName="taskName"
                        aria-label="task-name" aria-describedby="task-name">
                    </div>
                  </div>

                  <div class="col-sm-2">
                    <input type="color" class="form-control shadow-none form-control-color" formControlName="color"
                      id="exampleColorInput" value="#563d7c" title="Choose your color">
                  </div>
                  <div class="col-sm-6">
                    <div class="input-group">
                      <span class="input-group-text" id="task-start">Start</span>
                      <input type="datetime-local" class="form-control shadow-none" aria-label="task-start"
                        formControlName="taskStart" aria-describedby="task-start">
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="input-group">
                      <span class="input-group-text" id="task-end">End</span>
                      <input type="datetime-local" class="form-control shadow-none" aria-label="task-end"
                        formControlName="taskEnd" aria-describedby="task-end">
                    </div>
                  </div>

                  <h5>Successor</h5>

                  <div class="col-sm-6">
                    <div class="input-group">
                      <span class="input-group-text" id="successors-machine">Resource</span>
                      <select class="form-select shadow-none" aria-label="Default select example">
                        <option selected>Open this select menu</option>
                        <option value="1">One</option>
                        <option value="2">Two</option>
                        <option value="3">Three</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="input-group">
                      <span class="input-group-text" id="successors-task">Task</span>
                      <select class="form-select shadow-none" aria-label="Default select example">
                        <option selected>Open this select menu</option>
                        <option value="1">One</option>
                        <option value="2">Two</option>
                        <option value="3">Three</option>
                      </select>
                    </div>
                  </div>

                </div>
              </form>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" (click)="addTask()">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Right scrollable timeline -->
  <div class="gantt-scroll" #scrollHost>
    <svg [attr.width]="totalWidth" [attr.height]="totalHeight">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280"></polygon>
        </marker>
      </defs>

      <!-- Row background -->
      @for (row of rowLayout; track $index; let r = $index) {
      <ng-container>
        <rect class="row-band" x="0" [attr.y]="row.y" [attr.width]="timeWidth" [attr.height]="rowHeight"
          [attr.fill]="r % 2 === 0 ? '#ffffff' : '#fcfcfd'" />
      </ng-container>
      }


      @for (g of gridDays; track $index) {
      <ng-container>
        <line class="grid-line" [attr.x1]="g.x" y1="0" [attr.x2]="g.x" [attr.y2]="totalHeight" />
        <text [attr.x]="g.x + 4" y="16" font-size="12" fill="#6b7280">{{ g.label }}</text>
      </ng-container>
      }

      @if (showGridHours) {
      @for (h of gridHours; track $index) {
      <ng-container>
        <line class="hour-line" [attr.x1]="h.x" y1="0" [attr.x2]="h.x" [attr.y2]="totalHeight" />
        <text *ngIf="pxPerHour >= 8" [attr.x]="h.x + 2" y="28" font-size="9" fill="#9ca3af">{{ h.label }}</text>
      </ng-container>
      }
      }

      @if (todayX) {
      <line class="today-line" [attr.x1]="todayX" y1="0" [attr.x2]="todayX" [attr.y2]="totalHeight" />
      }

      @for (b of batchLayout; track $index) {
      <ng-container>
        <rect class="batch-rect" [attr.x]="b.x" [attr.y]="b.y + 6" [attr.width]="b.w" [attr.height]="rowHeight - 12"
          [attr.fill]="b.color || '#93c5fd'" (mouseenter)="hover=b" (mouseleave)="hover=null"></rect>
        <text class="batch-label" [attr.x]="b.x + 10" [attr.y]="b.y + rowHeight/2 + 4">{{ b.label }}</text>
      </ng-container>
      }

      @for (c of connectors; track $index) {
      <polyline class="connector" [attr.points]="c.points" fill="none" stroke="#6b7280" stroke-width="2"
        marker-end="url(#arrowhead)" />
      }

      <!-- Tooltip -->
      <g *ngIf="hover as h" class="tooltip">
        <rect [attr.x]="h.x + 8" [attr.y]="h.y - 28" rx="6" ry="6" width="220" height="24" fill="#111827"
          opacity="0.9" />
        <text [attr.x]="h.x + 16" [attr.y]="h.y - 12" font-size="12" fill="#fff">
          {{h.label}} · {{h.start | date:'MMM d, HH:mm'}} → {{h.end | date:'MMM d, HH:mm'}}
        </text>
      </g>
    </svg>
  </div>
</div>